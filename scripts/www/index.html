<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>â˜ï¸ ä½ çš„ä¸“å±äº‘ç«¯ä¹å›­</title>
    <link href="https://fonts.googleapis.com/css2?family=Zcool+KuaiLe&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary: #ff9a9e; --secondary: #fad0c4; --accent: #a18cd1; --text-main: #555;
            --glass-bg: rgba(255, 255, 255, 0.65); --glass-border: rgba(255, 255, 255, 0.4);
            --shadow-card: 0 10px 30px rgba(0, 0, 0, 0.05);
        }
        * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; user-select: none; }
        body {
            font-family: 'Zcool KuaiLe', sans-serif;
            background: linear-gradient(135deg, #e0c3fc 0%, #8ec5fc 100%);
            height: 100vh; overflow: hidden; display: flex; justify-content: center;
            color: var(--text-main); transition: background 1s, color 1s; overscroll-behavior: none;
        }
        /* å¤©æ°”é€‚é… */
        body.rainy { background: linear-gradient(to bottom, #2c3e50, #4ca1af); color: #fff; }
        body.rainy .card { background: rgba(0,0,0,0.25); border-color: rgba(255,255,255,0.1); color: #fff; }
        body.rainy .btn-outline { background: rgba(255,255,255,0.1); color: #fff; border-color: rgba(255,255,255,0.2); }
        body.snowy { background: linear-gradient(to bottom, #83a4d4, #b6fbff); }
        body.rainbow { background: linear-gradient(135deg, #ff9a9e, #fad0c4, #a18cd1); }

        .ambient-bg { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: -2; background: radial-gradient(circle at 50% 50%, rgba(255,255,255,0.4), transparent 80%); animation: breatheBg 8s ease-in-out infinite; }
        @keyframes breatheBg { 0%,100%{transform:scale(1);} 50%{transform:scale(1.2);} }

        /* ç”»å¸ƒå±‚çº§ç®¡ç† */
        #weather-canvas, #lantern-canvas, #fx-canvas, #ripple-canvas { position: fixed; inset: 0; pointer-events: none; }
        #weather-canvas { z-index: -1; }
        #ripple-canvas { z-index: -1; opacity: 0.6; } /* [æ–°å¢] æ¶Ÿæ¼ªç”»å¸ƒ */
        #lantern-canvas { z-index: 1500; }
        #fx-canvas { z-index: 2000; }

        /* [æ–°å¢] äº‘æœµä¼ ä¹¦å±‚ */
        #cloud-layer { position: fixed; inset: 0; pointer-events: none; z-index: 0; overflow: hidden; }
        .cloud-msg {
            position: absolute; background: rgba(255,255,255,0.7); border-radius: 30px;
            padding: 8px 16px; cursor: pointer; pointer-events: auto;
            box-shadow: 0 5px 15px rgba(0,0,0,0.05); font-size: 20px; color: #888;
            backdrop-filter: blur(5px); display: flex; align-items: center; justify-content: center;
        }
        .cloud-msg:hover { background: #fff; transform: scale(1.1); }

        .app-shell { width: 100%; max-width: 500px; height: 100%; position: relative; display: flex; flex-direction: column; filter: blur(20px); transform: scale(1.02); transition: filter 0.5s ease-out, transform 0.8s; }
        .page { position: absolute; inset: 0; padding: 20px 20px 120px; overflow-y: auto; opacity: 0; transform: translateY(15px) scale(0.98); transition: all 0.5s cubic-bezier(0.2, 0.8, 0.2, 1); pointer-events: none; scrollbar-width: none; }
        .page.active { opacity: 1; transform: translateY(0) scale(1); pointer-events: auto; }

        .card { background: var(--glass-bg); border: 1px solid var(--glass-border); border-radius: 28px; padding: 24px; margin-bottom: 20px; box-shadow: var(--shadow-card); backdrop-filter: blur(20px); position: relative; overflow: hidden; transition: 0.3s; }
        .card:active { transform: scale(0.99); }
        .card-title { font-size: 18px; margin-bottom: 16px; color: #7b68ee; display: flex; align-items: center; gap: 8px; letter-spacing: 1px; }
        body.rainy .card-title { color: #fff; }

        .btn { background: linear-gradient(120deg, #a18cd1 0%, #fbc2eb 100%); border: none; padding: 12px 24px; border-radius: 50px; color: #fff; font-size: 15px; cursor: pointer; transition: 0.2s; box-shadow: 0 6px 15px rgba(161, 140, 209, 0.4); }
        .btn:active { transform: scale(0.9); }
        .btn-outline { background: rgba(255,255,255,0.8); color: #666; border: 1px solid #fff; box-shadow: 0 4px 10px rgba(0,0,0,0.03); }

        /* ä¿¡ä»¶æ ·å¼ */
        .letter-trigger {
            width: 100%; text-align: center; margin-bottom: 15px; cursor: pointer;
            animation: float 3s ease-in-out infinite; opacity: 0.8; transition: 0.3s;
        }
        .letter-trigger:hover { opacity: 1; transform: scale(1.05); }
        .letter-icon { font-size: 40px; filter: drop-shadow(0 5px 10px rgba(255,105,180,0.3)); }
        .letter-hint { font-size: 12px; color: #888; margin-top: 5px; }

        #letter-modal {
            position: fixed; inset: 0; background: rgba(0,0,0,0.6); z-index: 8000;
            display: none; align-items: center; justify-content: center; backdrop-filter: blur(8px);
        }
        .letter-paper {
            background: #fff; width: 85%; max-width: 400px; padding: 30px; border-radius: 20px;
            box-shadow: 0 20px 50px rgba(0,0,0,0.2); position: relative;
            background-image: linear-gradient(#f1f1f1 1px, transparent 1px); background-size: 100% 30px;
            transform: translateY(20px); opacity: 0; transition: 0.5s;
        }
        .letter-paper.open { transform: translateY(0); opacity: 1; }
        .close-letter { position: absolute; top: 15px; right: 20px; font-size: 24px; color: #999; cursor: pointer; }

        /* å—æ°”åŒ… */
        .punch-char { font-size: 80px; text-align: center; transition: 0.1s; cursor: pointer; display: inline-block; }
        .punch-char.hit { transform: scale(0.8) rotate(15deg); }
        .hp-bar-bg { width: 80%; height: 10px; background: #eee; border-radius: 10px; margin: 10px auto; overflow: hidden; }
        .hp-bar { width: 100%; height: 100%; background: #ff9a9e; transition: 0.2s; }

        /* é€ƒè·‘æŒ‰é’® */
        .runaway-box { display: flex; justify-content: space-around; margin-top: 20px; height: 50px; position: relative; }
        .runaway-btn { position: absolute; right: 20px; transition: 0.1s; }

        /* è¯šå®é­”é•œ */
        .mirror-box {
            width: 140px; height: 180px; background: #ddd; margin: 0 auto; border-radius: 60px 60px 20px 20px;
            border: 6px solid #ffd700; position: relative; overflow: hidden; cursor: pointer;
            box-shadow: inset 0 0 20px rgba(0,0,0,0.1), 0 10px 20px rgba(0,0,0,0.1);
        }
        .mirror-cover { position: absolute; inset: 0; background: #ccc; display: flex; align-items: center; justify-content: center; transition: 0.8s; z-index: 2; color: #fff; font-size: 40px; }
        .mirror-content { position: absolute; inset: 0; background: #fff; display: flex; flex-direction: column; align-items: center; justify-content: center; z-index: 1; }

        /* çˆ±æ„å¤©å¹³ */
        .scale-sys { width: 100%; height: 120px; position: relative; display: flex; align-items: flex-end; justify-content: center; margin-top: 20px; }
        .scale-pole { width: 6px; height: 80px; background: #555; position: absolute; bottom: 0; }
        .scale-bar { width: 200px; height: 4px; background: #555; position: absolute; top: 40px; transition: transform 0.5s cubic-bezier(0.5, 1.5, 0.5, 1); }
        .scale-plate { width: 60px; height: 40px; border-bottom: 2px solid #555; border-radius: 0 0 30px 30px; position: absolute; top: 4px; display: flex; align-items: center; justify-content: center; font-size: 24px; }
        .scale-plate.left { left: 0; } .scale-plate.right { right: 0; }

        /* å…¶ä»–åŸæœ‰ç»„ä»¶ */
        .weather-bar { display: flex; justify-content: space-between; background: rgba(255,255,255,0.4); padding: 8px; border-radius: 20px; margin-bottom: 10px; }
        .w-btn { font-size: 20px; padding: 8px 15px; border-radius: 15px; cursor: pointer; transition: 0.2s; text-align: center; }
        .w-btn.active { background: #fff; transform: scale(1.1); color: var(--accent); }
        .bubble-grid { display: grid; grid-template-columns: repeat(5, 1fr); gap: 12px; justify-items: center; }
        .bubble { width: 45px; height: 45px; border-radius: 50%; background: radial-gradient(circle at 30% 30%, rgba(255,255,255,0.9), rgba(255,255,255,0.4)); box-shadow: inset 0 0 10px rgba(0,0,0,0.1); cursor: pointer; }
        .bubble.popped { background: rgba(255,255,255,0.2); transform: scale(0.9); }
        .oracle-book { width: 120px; height: 160px; background: linear-gradient(45deg, #667eea, #764ba2); border-radius: 5px 15px 15px 5px; margin: 0 auto; cursor: pointer; position: relative; color: #fff; text-align: center; padding: 15px; display:flex; align-items:center; justify-content:center; }
        .oracle-book.shake { animation: bookShake 0.5s ease-in-out; } @keyframes bookShake { 0%{transform:rotate(0)} 25%{transform:rotate(5deg)} 75%{transform:rotate(-5deg)} 100%{transform:rotate(0)} }

        .aid-grid { display: flex; justify-content: space-around; gap: 10px; }
        .aid-item { text-align: center; cursor: pointer; padding: 10px; border-radius: 15px; background: rgba(255,255,255,0.5); width: 30%; }
        .radio-box { background: #333; border-radius: 20px; padding: 15px; color: #fff; text-align: center; }
        .radio-controls { display: flex; justify-content: center; gap: 15px; }
        .radio-btn { width: 40px; height: 40px; border-radius: 50%; background: #555; display: flex; align-items: center; justify-content: center; cursor: pointer; }
        .radio-btn.active { background: var(--accent); }

        .pet-stage { height: 200px; display: flex; justify-content: center; align-items: center; background: radial-gradient(circle, rgba(255,255,255,0.5) 20%, transparent 70%); border-radius: 50%; }
        .pet-body { width: 140px; height: 140px; background: #fff; border-radius: 50%; position: relative; box-shadow: 0 15px 35px rgba(0,0,0,0.08); transition: 0.3s; }
        .pet-ear { position: absolute; top:-10px; width:40px; height:40px; background:#fff; border-radius:50% 50% 0 0; }
        .pet-ear.L { left:15px; transform:rotate(-15deg); } .pet-ear.R { right:15px; transform:rotate(15deg); }
        .face { position: relative; top:50px; text-align:center; }
        .eye { width:22px; height:22px; background:#333; border-radius:50%; display:inline-block; margin:0 12px; position:relative; overflow:hidden; transition: height 0.1s; }
        .pupil { width:8px; height:8px; background:#fff; border-radius:50%; position:absolute; top:4px; left:4px; }
        .mouth { width:20px; height:10px; background:#ff9a9e; border-radius:0 0 20px 20px; margin:12px auto 0; }
        .blush { position: absolute; top:58px; width:20px; height:10px; background:#ff9a9e; border-radius:50%; opacity:0.3; filter:blur(2px); }
        .blush.L { left:25px; } .blush.R { right:25px; }

        canvas.game-canvas { width: 100%; border-radius: 20px; touch-action: none; cursor: crosshair; }
        #gravity-canvas { height: 220px; background: rgba(255,255,255,0.3); } #hole-canvas { height: 180px; background: #1a1a2e; } #star-canvas { height: 250px; background: #2c3e50; } #knot-canvas { width: 100%; height: 220px; cursor: pointer; }

        .fruit-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px; margin-top: 15px; }
        .fruit-btn { background: rgba(255,255,255,0.7); border-radius: 18px; padding: 12px 5px; text-align: center; font-size: 12px; cursor: pointer; }
        .f-icon { font-size: 26px; display: block; margin-bottom: 6px; }

        .bottle-container { height: 180px; position: relative; overflow: hidden; background: linear-gradient(to top, #4ca1af, #c4e0e5); border-radius: 15px; display: flex; align-items: center; justify-content: center; }
        .bottle { font-size: 40px; position: absolute; transition: 2s; cursor: pointer; }
        .bottle-wave { position: absolute; bottom: 0; width: 200%; height: 50px; background: rgba(255,255,255,0.3); animation: wave 3s infinite linear; }
        @keyframes wave { 0%{transform:translateX(0)} 100%{transform:translateX(-50%)} }

        .piano-keys { display: flex; gap: 8px; height: 100px; }
        .key { flex: 1; background: #fff; border-radius: 0 0 15px 15px; cursor: pointer; display: flex; align-items: flex-end; justify-content: center; padding-bottom: 15px; color: #ccc; }
        .key.active { height: 95px; background: var(--accent); color: #fff; }

        .dock-wrapper { position: fixed; bottom: 25px; left: 0; width: 100%; display: flex; justify-content: center; z-index: 100; pointer-events: none; }
        .dock { background: rgba(255, 255, 255, 0.85); backdrop-filter: blur(20px); padding: 10px 30px; border-radius: 50px; display: flex; gap: 35px; box-shadow: 0 15px 40px rgba(0,0,0,0.08); pointer-events: auto; border: 1px solid rgba(255,255,255,0.6); }
        .dock-item { font-size: 26px; opacity: 0.4; transition: 0.3s; cursor: pointer; position: relative; }
        .dock-item.active { opacity: 1; transform: translateY(-8px) scale(1.15); }
        .dock-item.active::after { content: ''; position: absolute; bottom: -12px; left: 50%; transform: translateX(-50%); width: 5px; height: 5px; background: var(--accent); border-radius: 50%; }

        #tear-layer { position: fixed; inset: 0; z-index: 9999; cursor: crosshair; touch-action: none; transition: opacity 1.5s; }
        .tear-hint { position: absolute; top: 50%; left: 50%; transform: translate(-50%,-50%); text-align: center; pointer-events: none; color: #5d7599; text-shadow: 0 2px 10px rgba(255,255,255,0.8); animation: pulse 2s infinite; }
        @keyframes pulse { 0%,100%{opacity:0.6} 50%{opacity:1} }
        #toast { position: fixed; top: 40px; left: 50%; transform: translateX(-50%) translateY(-100px); background: #fff; padding: 12px 24px; border-radius: 30px; box-shadow: 0 10px 30px rgba(0,0,0,0.1); z-index: 5000; display: flex; align-items: center; gap: 10px; transition: 0.5s; }
        #toast.show { transform: translateX(-50%) translateY(0); }
        .gear-btn { position: fixed; top: 20px; right: 20px; font-size: 22px; opacity: 0.4; z-index: 500; cursor: pointer; }
        #settings-modal { position: fixed; inset: 0; background: rgba(0,0,0,0.3); z-index: 6000; display: none; align-items: center; justify-content: center; backdrop-filter: blur(4px); }
        .modal-box { background: #fff; padding: 30px; border-radius: 25px; width: 85%; max-width: 320px; text-align: center; }
        .modal-input { width: 100%; padding: 12px; border: 1px solid #eee; border-radius: 12px; margin: 10px 0; background: #f9f9f9; text-align: center; outline: none; }
    </style>
</head>
<body>

<div class="ambient-bg"></div>
<div id="cloud-layer"></div> <canvas id="weather-canvas"></canvas>
<canvas id="lantern-canvas"></canvas>
<canvas id="ripple-canvas"></canvas> <canvas id="fx-canvas"></canvas>

<div id="tear-layer">
    <canvas id="tear-canvas"></canvas>
    <div class="tear-hint">
        <div style="font-size:50px; margin-bottom:10px; filter: blur(1px);">ğŸ˜¢</div>
        <p style="font-size:18px; color:#5d7599; font-weight:bold; letter-spacing:1px;">çœ¼æ³ªæ¨¡ç³Šäº†è§†çº¿...</p>
        <p style="font-size:14px; margin-top:8px; opacity:0.8;">è¯·å¸®æˆ‘æ“¦å¹²ï¼Œçœ‹çœ‹çœŸå®çš„ä½ </p>
    </div>
</div>

<div id="toast"><span>ğŸŒˆ</span> <span id="t-msg">Ready</span></div>
<div class="gear-btn" onclick="openSettings()">âš™ï¸</div>

<div class="app-shell" id="main-app">

    <div id="page-home" class="page active">
        <div class="card" style="margin-top: 40px;">
            <div class="card-title">ğŸŒ¤ï¸ å¿ƒæƒ…å¤©æ°”æ§åˆ¶å™¨</div>
            <div class="weather-bar">
                <div class="w-btn active" onclick="setWeather('sunny', this)">â˜€ï¸<br><span>æ™´æœ—</span></div>
                <div class="w-btn" onclick="setWeather('rainy', this)">ğŸŒ§ï¸<br><span>é›¨å¤©</span></div>
                <div class="w-btn" onclick="setWeather('snowy', this)">â„ï¸<br><span>ä¸‹é›ª</span></div>
                <div class="w-btn" onclick="setWeather('rainbow', this)">ğŸŒˆ<br><span>å½©è™¹</span></div>
            </div>
        </div>

        <div class="letter-trigger" onclick="openLetter()">
            <div class="letter-icon">ğŸ’Œ</div>
            <div class="letter-hint">æœ‰ä¸€å°ç»™ä½ çš„ä¿¡ (ç‚¹å‡»æ‹†å¼€)</div>
        </div>

        <div class="card">
            <div class="card-title">ğŸ  å®ˆæŠ¤èŒå® </div>
            <div class="pet-stage" onclick="petTap()">
                <div class="pet-body" id="pet">
                    <div class="pet-ear L"></div><div class="pet-ear R"></div>
                    <div class="blush L"></div><div class="blush R"></div>
                    <div class="face">
                        <div class="eye"><div class="pupil" id="pl"></div></div>
                        <div class="eye"><div class="pupil" id="pr"></div></div>
                        <div class="mouth" id="mouth"></div>
                    </div>
                </div>
            </div>
            <div style="display:flex; justify-content:center; gap:10px; margin-top:20px;">
                <button class="btn-outline" style="border-radius:20px; padding:5px 15px; cursor:pointer;" onclick="petAct('hug')">ğŸ¤— æŠ±æŠ±</button>
                <button class="btn-outline" style="border-radius:20px; padding:5px 15px; cursor:pointer;" onclick="petAct('feed')">ğŸ– æŠ•å–‚</button>
                <button class="btn-outline" style="border-radius:20px; padding:5px 15px; cursor:pointer;" onclick="togglePet()">ğŸª„ å˜èº«</button>
            </div>
        </div>

        <div class="card">
            <div class="card-title">ğŸ¤” åŸè°…æˆ‘å¥½ä¸å¥½ï¼Ÿ</div>
            <div class="runaway-box">
                <button class="btn" onclick="forgive()" style="position:absolute; left:20px;">å¥½å‘€ â¤ï¸</button>
                <button class="btn btn-outline runaway-btn" onmouseover="runButton(this)" ontouchstart="runButton(this)">ä¸å¥½ ğŸ˜</button>
            </div>
        </div>

        <div class="card">
            <div class="card-title">ğŸ“œ ç”µå­ä¿è¯ä¹¦</div>
            <div style="background:#fff; padding:20px; transform:rotate(-1deg); border-radius:15px; text-align:center; border:1px dashed #ddd; box-shadow:0 5px 15px rgba(0,0,0,0.03);">
                <p style="line-height:1.8; color:#555; font-size:14px;">
                    ç”²æ–¹(ç”°å®)æ‰¿è¯ºï¼šä»¥ååšä½ çš„å‡ºæ°”ç­’ã€‚<br>
                    ä¹™æ–¹(ç‹å¥•å©·)æ‰¿è¯ºï¼šæ“¦å¹²çœ¼æ³ªï¼ŒåŸè°…ç¬¨è›‹ï¼Œè¦å¼€å¼€å¿ƒå¿ƒçš„ï¼Œä¸å“­ã€‚
                </p>
                <div id="fingerprint" onclick="signPromise(this)"
                     style="width:50px; height:70px; border:2px dashed var(--accent); margin:20px auto 5px;
                            display:flex; align-items:center; justify-content:center; color:var(--accent); cursor:pointer; border-radius:10px;">
                    æŒ‰
                </div>
            </div>
        </div>
    </div>

    <div id="page-fun" class="page">
        <div class="card" style="margin-top: 40px;">
            <div class="card-title">ğŸ¥Š ä¸“å±å—æ°”åŒ…</div>
            <div style="text-align:center;">
                <div class="punch-char" onclick="punch(this)">ğŸ¤¡</div>
                <div class="hp-bar-bg"><div class="hp-bar" id="hp-bar"></div></div>
                <p id="punch-msg" style="font-size:12px; color:#aaa; margin-top:5px;">ç”¨åŠ›æˆ³ä»–å‡ºæ°”ï¼</p>
            </div>
        </div>

        <div class="card">
            <div class="card-title">ğŸ”® è¯šå®é­”é•œ</div>
            <div class="mirror-box" onclick="revealMirror()">
                <div class="mirror-cover" id="mirror-cover">â”</div>
                <div class="mirror-content">
                    <div style="font-size:20px; color:var(--primary); font-weight:bold;">ç‹å¥•å©·</div>
                    <div style="font-size:12px; color:#aaa;">(ä¸–ä¸Šæœ€å¯çˆ±)</div>
                </div>
            </div>
            <p style="text-align:center; font-size:12px; color:#aaa; margin-top:5px;">é­”é•œé­”é•œï¼Œè°æœ€å¯çˆ±ï¼Ÿ</p>
        </div>

        <div class="card">
            <div class="card-title">ğŸ«§ æ— é™ææ³¡æ³¡</div>
            <div class="bubble-grid" id="bubble-wrap"></div>
        </div>

        <div class="card">
            <div class="card-title">ğŸŠ å“„äººæ°´æœé“º</div>
            <div class="fruit-grid">
                <div class="fruit-btn" onclick="fAct('durian', this)"><span class="f-icon">ğŸˆ</span>è·ªé”®ç›˜</div>
                <div class="fruit-btn" onclick="fAct('orange', this)"><span class="f-icon">ğŸŠ</span>å¥½è¿ç­¾</div>
                <div class="fruit-btn" onclick="fAct('watermelon', this)"><span class="f-icon">ğŸ‰</span>é™ç«é›¨</div>
                <div class="fruit-btn" onclick="fAct('cherry', this)"><span class="f-icon">ğŸ’</span>ä¸åˆ†ç¦»</div>
                <div class="fruit-btn" onclick="fAct('mangosteen', this)"><span class="f-icon">ğŸ¥¥</span>å°å…¬ä¸»</div>
                <div class="fruit-btn" onclick="fAct('grape', this)"><span class="f-icon">ğŸ‡</span>æˆ³æ°”æ³¡</div>
                <div class="fruit-btn" onclick="fAct('strawberry', this)"><span class="f-icon">ğŸ“</span>ç”œç”œå“’</div>
                <div class="fruit-btn" onclick="fAct('kiwi', this)"><span class="f-icon">ğŸ¥</span>æ¯›èŒ¸èŒ¸</div>
            </div>
        </div>

        <div class="card">
            <div class="card-title">ğŸ“ é‡åŠ›æ°´æœç¼¸</div>
            <canvas id="gravity-canvas" class="game-canvas"></canvas>
        </div>

        <div class="card">
            <div class="card-title">ğŸ æƒ…ç»ªè´©å–æœº</div>
            <div style="background:linear-gradient(to right, #ff9a9e, #fecfef); padding:20px; border-radius:20px; text-align:center; color:white;">
                <div style="background:rgba(255,255,255,0.2); height:70px; border-radius:12px; display:flex; align-items:center; justify-content:center; font-size:35px; margin-bottom:15px;">
                    <span id="vm-res">â“</span>
                </div>
                <button class="btn" style="background:#fff; color:#ff9a9e;" onclick="playVm()">æŠ•å¸è·å–å¿«ä¹</button>
            </div>
        </div>
    </div>

    <div id="page-calm" class="page">
        <div class="card" style="margin-top: 40px;">
            <div class="card-title">ğŸ§¶ è§£å¼€å¿ƒç»“ (æŠšæ‘¸å±å¹•)</div>
            <canvas id="knot-canvas"></canvas>
        </div>

        <div class="card">
            <div class="card-title">ğŸ”® ç­”æ¡ˆä¹‹ä¹¦</div>
            <div style="min-height:180px; display:flex; flex-direction:column; align-items:center; justify-content:center;">
                <p style="font-size:13px; color:#888; margin-bottom:20px;">é»˜å¿µä½ çš„çƒ¦æ¼ï¼Œç‚¹å‡»å°é¢...</p>
                <div class="oracle-book" onclick="askOracle()">
                    <div id="oracle-content">
                        <div style="font-size:40px;">ğŸ“œ</div>
                        <div>ç­”æ¡ˆä¹‹ä¹¦</div>
                    </div>
                </div>
            </div>
        </div>

        <div class="card">
            <div class="card-title">ğŸ©¹ æƒ…ç»ªæ€¥æ•‘ç®±</div>
            <div class="aid-grid">
                <div class="aid-item" onclick="useAid('bandaid')"><span class="aid-icon">ğŸ©¹</span><br><span style="font-size:12px">ç¼è¡¥å¿ƒç¢</span></div>
                <div class="aid-item" onclick="useAid('pill')"><span class="aid-icon">ğŸ’Š</span><br><span style="font-size:12px">å¿˜å¿§è¯</span></div>
                <div class="aid-item" onclick="useAid('pat')"><span class="aid-icon">ğŸ‘‹</span><br><span style="font-size:12px">æ‘¸æ‘¸å¤´</span></div>
            </div>
        </div>

        <div class="card">
            <div class="card-title">ğŸ“» æ™šå®‰ç”µå°</div>
            <div class="radio-box">
                <div class="radio-screen" id="radio-display">FM 52.0 - Waiting...</div>
                <div class="radio-controls">
                    <div class="radio-btn" onclick="playRadio('rain', this)">ğŸŒ§ï¸</div>
                    <div class="radio-btn" onclick="playRadio('ocean', this)">ğŸŒŠ</div>
                    <div class="radio-btn" onclick="playRadio('fire', this)">ğŸ”¥</div>
                    <div class="radio-btn" onclick="stopRadio()">â¹ï¸</div>
                </div>
            </div>
        </div>

        <div class="card">
            <div class="card-title">ğŸ•³ï¸ çƒ¦æ¼ç²‰ç¢æœº</div>
            <div style="display:flex; gap:10px; margin-bottom:15px;">
                <input id="worry-in" placeholder="å†™ä¸‹ä¸å¼€å¿ƒ..." style="flex:1; padding:12px; border:1px solid #eee; border-radius:12px; outline:none; background:#f9f9f9;">
                <button class="btn" onclick="fireBlackHole()" style="padding:10px 20px;">ç²‰ç¢</button>
            </div>
            <canvas id="hole-canvas" class="game-canvas"></canvas>
        </div>

        <div class="card">
            <div class="card-title">ğŸ¹ æ²»æ„ˆé’¢ç´</div>
            <div class="piano-keys">
                <div class="key" onclick="note(261, this)">Do</div>
                <div class="key" onclick="note(293, this)">Re</div>
                <div class="key" onclick="note(329, this)">Mi</div>
                <div class="key" onclick="note(392, this)">So</div>
                <div class="key" onclick="note(440, this)">La</div>
            </div>
        </div>
    </div>

    <div id="page-love" class="page">
        <div class="card" style="margin-top: 40px;">
            <div class="card-title">âš–ï¸ çˆ±æ„å¤©å¹³</div>
            <div class="scale-sys" onclick="tipScale()">
                <div class="scale-pole"></div>
                <div class="scale-bar" id="scale-bar">
                    <div class="scale-plate left">â˜ï¸</div>
                    <div class="scale-plate right">â¤ï¸</div>
                </div>
            </div>
            <p style="text-align:center; font-size:12px; color:#aaa; margin-top:10px;">ç‚¹å‡»æ”¾å…¥æˆ‘çš„çˆ±ï¼Œçœ‹çœ‹è°é‡ï¼Ÿ</p>
        </div>

        <div class="card">
            <div class="card-title">ğŸŒŠ æ¼‚æµç“¶å›å“</div>
            <div class="bottle-container" onclick="throwBottle()">
                <div class="bottle" id="bottle-emoji">ğŸ¾</div>
                <div class="bottle-wave"></div>
                <div id="bottle-msg" style="position:absolute; color:#fff; font-weight:bold; opacity:0; text-align:center; padding:10px;"></div>
            </div>
            <div style="display:flex; gap:10px; margin-top:10px;">
                <input id="bottle-in" placeholder="æŠŠå¿ƒäº‹è£…è¿›ç“¶å­..." style="flex:1; padding:10px; border:1px solid #eee; border-radius:10px; outline:none;">
                <button class="btn" onclick="throwBottle()" style="padding:8px 15px;">æ‰”å‡º</button>
            </div>
        </div>

        <div class="card">
            <div class="card-title">ğŸ‹ å¿ƒæ„¿å­”æ˜ç¯</div>
            <div style="display:flex; gap:10px; margin-bottom:10px;">
                <input id="wish-in" placeholder="è®¸ä¸€ä¸ªæ„¿æœ›..." style="flex:1; padding:12px; border:1px solid #eee; border-radius:12px; outline:none; background:#f9f9f9;">
                <button class="btn" onclick="fireLantern()" style="padding:10px 20px;">æ”¾é£</button>
            </div>
        </div>

        <div class="card">
            <div class="card-title">âœ¨ æ˜Ÿç©ºè¿çº¿</div>
            <canvas id="star-canvas" class="game-canvas"></canvas>
            <div id="star-msg" style="text-align:center; color:var(--accent); font-weight:bold; margin-top:15px; opacity:0; transition:0.5s;"></div>
        </div>

        <div class="card">
            <div class="card-title">ğŸ’Œ æƒŠå–œåˆ®åˆ®ä¹</div>
            <div style="position:relative; height:180px; width:100%; border-radius:20px; overflow:hidden; border:1px solid #eee;">
                <div style="position:absolute; inset:0; background:#fff0f5; display:flex; flex-direction:column; align-items:center; justify-content:center;">
                    <div style="font-size:40px;">ğŸ’‘</div>
                    <div style="margin-top:10px; font-weight:bold; color:#555;" id="love-msg">åŸè°…æˆ‘å¥½ä¸å¥½ï¼Ÿ</div>
                </div>
                <canvas id="scratch-canvas" style="position:absolute; inset:0; cursor:crosshair; touch-action:none;"></canvas>
            </div>
            <button class="btn-outline" style="width:100%; margin-top:10px; padding:8px; border-radius:10px;" onclick="resetScratch()">ğŸ”„ é‡æ–°è¦†ç›–</button>
        </div>
    </div>

</div>

<div id="letter-modal">
    <div class="letter-paper">
        <div class="close-letter" onclick="closeLetter()">Ã—</div>
        <h3 style="color:var(--primary); margin-bottom:15px;">ğŸ’Œ è‡´ ç‹å¥•å©·</h3>
        <p style="line-height:2; font-size:15px; color:#555; text-align:justify;">
            ç‹å¥•å©·ï¼Œå¸Œæœ›ä½ çœ‹åˆ°è¿™äº›ä¼šå–œæ¬¢ï¼Œä¼šå¼€å¿ƒã€‚<br>
            ä¹Ÿå¸Œæœ›è¿™ä¸ªç¨‹åºå¯ä»¥ä¸€ç›´é™ªç€ä½ ï¼Œåœ¨ä½ ä¸å¼€å¿ƒçš„æ—¶å€™é™ªç€ä½ ï¼Œåœ¨ä½ æƒ³å“­çš„æ—¶å€™é™ªç€ä½ ï¼Œæ°¸è¿œé™ªç€ä½ ã€‚<br>
            <b style="color:#ff9a9e">ä½ ä»¥åä¸è®¸å“­é¼»å­äº†å“¦ï¼Œè¦å¼€å¼€å¿ƒå¿ƒçš„ã€‚</b><br>
            ä¸å¼€å¿ƒçš„æ—¶å€™ï¼Œå°±çœ‹çœ‹è¿™ä¸ªï¼Œè®©å¥¹æ¥å“„ä½ å¼€å¿ƒ â¤ï¸
        </p>
    </div>
</div>

<div class="dock-wrapper">
    <div class="dock">
        <div class="dock-item active" onclick="nav('home', this)">ğŸ </div>
        <div class="dock-item" onclick="nav('fun', this)">ğŸ¡</div>
        <div class="dock-item" onclick="nav('calm', this)">ğŸƒ</div>
        <div class="dock-item" onclick="nav('love', this)">â¤ï¸</div>
    </div>
</div>

<div id="settings-modal">
    <div class="modal-box">
        <h3>âš™ï¸ ä¸“å±å®šåˆ¶</h3>
        <input id="set-name" class="modal-input" placeholder="å¥¹çš„æ˜µç§°">
        <input id="set-msg" class="modal-input" placeholder="é“æ­‰/è¡¨ç™½çš„è¯">
        <button class="btn" onclick="saveSettings()">ä¿å­˜ç”Ÿæ•ˆ</button>
        <button class="btn-outline" style="margin-top:10px; border:none; background:transparent;" onclick="$('settings-modal').style.display='none'">å…³é—­</button>
    </div>
</div>

<script>
    const $ = id => document.getElementById(id);
    const AudioCtx = window.AudioContext || window.webkitAudioContext;
    let audio;
    let w = window.innerWidth, h = window.innerHeight;
    const fxCvs = $('fx-canvas'); const fxCtx = fxCvs.getContext('2d');
    fxCvs.width = w; fxCvs.height = h;

    // Config
    const config = {
        name: localStorage.getItem('u_name') || 'å°å…¬ä¸»',
        msg: localStorage.getItem('u_msg') || 'å¯¹ä¸èµ·ï¼Œæˆ‘æœ€çˆ±ä½ äº†',
        pet: 'cat'
    };
    $('love-msg').innerText = config.msg;

    window.addEventListener('resize', () => { w = window.innerWidth; h = window.innerHeight; fxCvs.width = w; fxCvs.height = h; });

    function initAudio() { if(!audio) audio = new AudioCtx(); }
    function playTone(freq, type='sine', dur=0.2) {
        if(!audio) return;
        const o = audio.createOscillator(); const g = audio.createGain();
        o.type = type; o.frequency.value = freq;
        g.gain.setValueAtTime(0.1, audio.currentTime);
        g.gain.exponentialRampToValueAtTime(0.001, audio.currentTime + dur);
        o.connect(g); g.connect(audio.destination);
        o.start(); o.stop(audio.currentTime + dur);
        // [æ–°å¢] è§¦å‘æ¶Ÿæ¼ª
        triggerRipple();
    }
    function showToast(msg) {
        const t = $('toast'); $('t-msg').innerText = msg;
        t.classList.add('show'); setTimeout(()=>t.classList.remove('show'), 2500);
    }
    function speak(text) {
        window.speechSynthesis.cancel();
        const u = new SpeechSynthesisUtterance(text);
        u.lang = 'zh-CN'; u.rate = 0.9; u.pitch = 1.1;
        window.speechSynthesis.speak(u);
    }

    // Nav
    function nav(id, el) {
        document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
        $('page-' + id).classList.add('active');
        document.querySelectorAll('.dock-item').forEach(i => i.classList.remove('active'));
        el.classList.add('active');
        if(id === 'fun') { initGravity(); initBubbles(); }
        if(id === 'calm') { initBlackHole(); initKnot(); }
        if(id === 'love') { initStar(); initScratch(); initLanterns(); }
    }

    // --- 1. æ“¦çœ¼æ³ª ---
    const tcvs = $('tear-canvas'); const tctx = tcvs.getContext('2d');
    let tearCleared = false, wipeCount = 0;
    const appShell = $('main-app');
    function initTear() {
        tcvs.width = w; tcvs.height = h;
        tctx.fillStyle = 'rgba(230, 240, 255, 0.95)'; tctx.fillRect(0,0,w,h);
        tctx.globalCompositeOperation = 'source-over';
        tctx.fillStyle = 'rgba(255, 255, 255, 0.6)';
        for(let i=0; i<30; i++) { tctx.beginPath(); tctx.arc(Math.random()*w, Math.random()*h, Math.random()*15+5, 0, Math.PI*2); tctx.fill(); }
        tctx.globalCompositeOperation = 'destination-out';
        const wipe = (e) => {
            e.preventDefault(); initAudio();
            const t = e.touches ? e.touches[0] : e;
            tctx.beginPath(); tctx.arc(t.clientX, t.clientY, 45, 0, Math.PI*2); tctx.fill();
            wipeCount++;
            let blur = Math.max(0, 20 - (wipeCount/3));
            appShell.style.filter = `blur(${blur}px)`;
            if(wipeCount > 60 && !tearCleared) {
                tearCleared = true;
                $('tear-layer').style.opacity = 0;
                appShell.style.filter = 'blur(0px)'; appShell.style.transform = 'scale(1)';
                setTimeout(() => $('tear-layer').style.display='none', 1500);
                showToast("çœ¼æ³ªæ“¦å¹²å•¦ âœ¨"); speak("åˆ«å“­å•¦ï¼Œå°å…¬ä¸»ï¼Œæ¬¢è¿å›å®¶"); startBlinking();
            }
        };
        tcvs.addEventListener('mousemove', wipe); tcvs.addEventListener('touchmove', wipe);
    }
    initTear();

    // --- [æ–°å¢] éŸ³å¾‹æ¶Ÿæ¼ª ---
    const rCvs = document.getElementById('ripple-canvas');
    const rCtx = rCvs.getContext('2d');
    rCvs.width = w; rCvs.height = h;
    let ripples = [];
    function triggerRipple() { ripples.push({r: 0, a: 0.6, w: 5}); }
    function loopRipples() {
        rCtx.clearRect(0,0,w,h);
        ripples.forEach((r, i) => {
            r.r += 5; r.a -= 0.01; r.w -= 0.05;
            if(r.a <= 0) { ripples.splice(i, 1); return; }
            rCtx.beginPath(); rCtx.arc(w/2, h/2, r.r, 0, Math.PI*2);
            rCtx.strokeStyle = `rgba(255, 182, 193, ${r.a})`; rCtx.lineWidth = Math.max(0.5, r.w); rCtx.stroke();
        });
        requestAnimationFrame(loopRipples);
    }
    loopRipples();

    // --- [æ–°å¢] äº‘æœµä¼ ä¹¦ ---
    const cloudTexts = ["æƒ³ä½ äº†", "æŠ±æŠ±", "è´´è´´", "ä»Šå¤©ä¹Ÿè¦å¼€å¿ƒ", "å‘¼å™œå‘¼å™œæ¯›", "æˆ‘åœ¨å‘¢", "â¤ï¸"];
    function spawnCloud() {
        const c = document.createElement('div');
        c.className = 'cloud-msg';
        c.innerText = "â˜ï¸";
        c.style.top = Math.random() * 60 + 10 + "%";
        c.style.left = "-100px";
        c.style.transition = `left ${20 + Math.random()*10}s linear, transform 0.5s, opacity 0.5s, background 0.3s`;
        document.getElementById('cloud-layer').appendChild(c);
        setTimeout(() => c.style.left = "110%", 100);
        c.onclick = () => {
            initAudio(); c.innerText = cloudTexts[Math.floor(Math.random()*cloudTexts.length)];
            c.style.transform = "scale(1.5)"; c.style.background = "#fff0f5"; playTone(600, 'sine', 0.1);
            setTimeout(() => { c.style.opacity = 0; setTimeout(()=>c.remove(), 500); }, 2000);
        };
        setTimeout(() => c.remove(), 35000);
    }
    setInterval(spawnCloud, 10000);

    // --- ä¿¡ä»¶é€»è¾‘ ---
    function openLetter() { initAudio(); $('letter-modal').style.display='flex'; setTimeout(()=>document.querySelector('.letter-paper').classList.add('open'),50); playTone(300,'sine',0.5); }
    function closeLetter() { document.querySelector('.letter-paper').classList.remove('open'); setTimeout(()=>$('letter-modal').style.display='none',500); }

    // --- 1. å—æ°”åŒ… ---
    let punchHp=100;
    function punch(el) {
        initAudio(); punchHp-=10; if(punchHp<0)punchHp=100; $('hp-bar').style.width=punchHp+"%";
        el.classList.add('hit'); setTimeout(()=>el.classList.remove('hit'),100);
        if(punchHp<=0) { el.innerText="ğŸ³ï¸"; $('punch-msg').innerText="æˆ‘é”™äº†ï¼åˆ«æ‰“å•¦"; showToast("å‡ºæ°”æˆåŠŸï¼"); }
        else { el.innerText=["ğŸ˜£","ğŸ˜«","ğŸ¤•","ğŸ˜­"][Math.floor(Math.random()*4)]; playTone(200,'sawtooth',0.1); if(navigator.vibrate)navigator.vibrate(50); }
    }

    // --- 2. é€ƒè·‘æŒ‰é’® ---
    function runButton(btn) {
        initAudio(); const x=(Math.random()-0.5)*200; const y=(Math.random()-0.5)*100;
        btn.style.transform=`translate(${x}px, ${y}px)`; playTone(600,'triangle',0.1);
    }
    function forgive() { showToast("å°±çŸ¥é“ä½ æœ€å¥½äº† â¤ï¸"); createParticles(w/2, h/2, ['ğŸ‰','â¤ï¸']); playTone(400,'sine',0.1); }

    // --- 3. é­”é•œ ---
    function revealMirror() {
        initAudio(); const cover=$('mirror-cover');
        if(cover.style.opacity==='0')return;
        cover.style.opacity='0'; playTone(500,'sine',0.5); showToast("é­”é•œä¸ä¼šæ’’è° âœ¨"); createParticles(w/2, h/2, ['âœ¨']);
    }

    // --- 4. å¤©å¹³ ---
    function tipScale() {
        initAudio(); $('scale-bar').style.transform="rotate(20deg)";
        showToast("çˆ±æ„é‡äºæ³°å±±ï¼"); playTone(300,'sine',0.2);
        setTimeout(()=>{ const c=document.querySelector('.scale-plate.left'); c.innerText="ğŸ’¨"; c.style.transition="1s"; c.style.transform="translate(-50px, -100px) scale(0)"; c.style.opacity="0"; },300);
    }

    // --- å¤©æ°” ---
    const wc=$('weather-canvas'); const wctx=wc.getContext('2d'); wc.width=w; wc.height=h; let wInterval;
    function setWeather(type, el) {
        document.querySelectorAll('.w-btn').forEach(b=>b.classList.remove('active')); el.classList.add('active');
        document.body.className=''; if(type!=='sunny')document.body.classList.add(type);
        clearInterval(wInterval); wctx.clearRect(0,0,w,h);
        if(type==='rainy'||type==='snowy') startPrecipitation(type);
        if(type==='rainbow') showToast("é›¨è¿‡å¤©æ™´ï¼Œå½©è™¹å‡ºç°ğŸŒˆ");
        if(type==='sunny') showToast("ä»Šå¤©æ˜¯æ™´å¤©â˜€ï¸");
    }
    function startPrecipitation(type) {
        let ps=[]; for(let i=0;i<60;i++) ps.push({x:Math.random()*w, y:Math.random()*h, v:Math.random()*3+2, s:Math.random()*2+1});
        wInterval = setInterval(() => {
            wctx.clearRect(0,0,w,h); wctx.fillStyle='rgba(255,255,255,0.8)'; wctx.strokeStyle='rgba(255,255,255,0.5)';
            ps.forEach(p => {
                p.y+=p.v; if(p.y>h){p.y=-10; p.x=Math.random()*w;}
                if(type==='rainy') { wctx.beginPath(); wctx.moveTo(p.x, p.y); wctx.lineTo(p.x, p.y+10); wctx.stroke(); }
                else { wctx.beginPath(); wctx.arc(p.x, p.y, p.s, 0, Math.PI*2); wctx.fill(); p.x+=Math.sin(p.y/50)*0.5; }
            });
        }, 30);
    }

    let bubblesInit = false;
    function initBubbles() {
        if(bubblesInit) return;
        const g=$('bubble-wrap');
        for(let i=0; i<25; i++) {
            const b=document.createElement('div'); b.className='bubble';
            b.onclick=function(){ if(this.classList.contains('popped'))return; initAudio(); this.classList.add('popped'); playTone(300+Math.random()*200,'square',0.1); if(navigator.vibrate)navigator.vibrate(50); }
            g.appendChild(b);
        }
        bubblesInit=true;
    }

    const answers=["åˆ«æƒ³å¤ªå¤š","å»åƒé¡¿å¥½çš„","å¼€å¿ƒæœ€é‡è¦","å¬ä»å†…å¿ƒ","æŠ±æŠ±è‡ªå·±","ä¼šå¥½è¿çš„","ä»–å·²ç»åœ¨åçœäº†","ä¹°ä¹°ä¹°ï¼","å†è¯•ä¸€æ¬¡","ä½ æ˜¯æœ€æ£’çš„"];
    function askOracle() {
        initAudio(); const book=document.querySelector('.oracle-book'); const content=$('oracle-content');
        if(book.classList.contains('shake')) return;
        book.classList.add('shake'); playTone(100,'sawtooth',0.3);
        setTimeout(() => {
            book.classList.remove('shake'); const ans=answers[Math.floor(Math.random()*answers.length)];
            content.innerHTML=`<div style="font-size:18px; font-weight:bold;">${ans}</div>`;
            showToast("å‘½è¿çš„æŒ‡å¼• âœ¨"); setTimeout(()=>{ content.innerHTML=`<div style="font-size:40px;">ğŸ“œ</div><div>ç­”æ¡ˆä¹‹ä¹¦</div>`; },3000);
        }, 600);
    }

    function useAid(type) { initAudio(); if(type==='bandaid') { showToast("æ­£åœ¨ç¼è¡¥å¿ƒç¢..."); createParticles(w/2, h/2, ['ğŸ©¹','â¤ï¸']); } else if(type==='pill') { showToast("çƒ¦æ¼å»æ— è¸ªï¼"); createParticles(w/2, h/2, ['ğŸ’Š','âœ¨']); } else if(type==='pat') { showToast("æ‘¸æ‘¸å¤´ï¼Œä¸å“­å•¦"); playTone(400,'sine',0.2); } }

    let radioOsc, radioGain;
    function playRadio(type, el) {
        initAudio(); stopRadio();
        document.querySelectorAll('.radio-btn').forEach(b=>b.classList.remove('active')); el.classList.add('active');
        radioOsc=audio.createOscillator(); radioGain=audio.createGain();
        if(type==='rain') $('radio-display').innerText="FM 52.0 - Rainy Mood";
        else if(type==='ocean') $('radio-display').innerText="FM 52.0 - Ocean Waves";
        else $('radio-display').innerText="FM 52.0 - Bonfire";
        const bufSize=audio.sampleRate*2; const buffer=audio.createBuffer(1,bufSize,audio.sampleRate); const data=buffer.getChannelData(0);
        for(let i=0;i<bufSize;i++) data[i]=Math.random()*2-1;
        const noise=audio.createBufferSource(); noise.buffer=buffer; noise.loop=true;
        const filter=audio.createBiquadFilter();
        if(type==='rain') { filter.type='lowpass'; filter.frequency.value=800; }
        else if(type==='ocean') { filter.type='lowpass'; filter.frequency.value=300; }
        else { filter.type='highpass'; filter.frequency.value=1000; }
        noise.connect(filter); filter.connect(radioGain); radioGain.connect(audio.destination); radioGain.gain.value=0.1;
        noise.start(); radioOsc=noise;
    }
    function stopRadio() { if(radioOsc){try{radioOsc.stop();}catch(e){} radioOsc=null;} document.querySelectorAll('.radio-btn').forEach(b=>b.classList.remove('active')); $('radio-display').innerText="FM 52.0 - Waiting..."; }

    document.addEventListener('mousemove', e=>moveEye(e.clientX, e.clientY));
    document.addEventListener('touchmove', e=>moveEye(e.touches[0].clientX, e.touches[0].clientY));
    function moveEye(mx, my) {
        const ps=[$('pl'), $('pr')];
        ps.forEach(p=>{ const r=p.getBoundingClientRect(); const x=r.left+r.width/2, y=r.top+r.height/2; const a=Math.atan2(my-y, mx-x); const d=Math.min(4, Math.hypot(mx-x, my-y)/15); p.style.transform=`translate(${Math.cos(a)*d}px, ${Math.sin(a)*d}px)`; });
    }
    function startBlinking() { setInterval(()=>{ document.querySelectorAll('.eye').forEach(e=>e.style.height='2px'); setTimeout(()=>document.querySelectorAll('.eye').forEach(e=>e.style.height='24px'), 150); }, 3500); }
    function petTap() { initAudio(); $('pet').style.transform="scale(0.9)"; setTimeout(()=>$('pet').style.transform="scale(1)",150); showToast("è¹­è¹­ä½ ~"); playTone(400,'sine',0.1); }
    function petAct(type) { if(type==='hug'){ $('pet').style.transform="scale(1.2)"; showToast("æŠ±ç´§ç´§ï¼"); setTimeout(()=>$('pet').style.transform="scale(1)",1000); } else if(type==='feed'){ createParticles(w/2, 200, ['ğŸ–']); showToast("å¥½åƒï¼"); } }
    let pRole='cat'; function togglePet() { pRole=pRole==='cat'?'dog':'cat'; const p=$('pet'); p.style.transform="scale(0)"; setTimeout(()=>{ p.style.transform="scale(1)"; showToast(pRole==='cat'?'å–µå–µå˜èº«':'ä¿®å‹¾å˜èº«'); },300); }
    function signPromise(el) { if(el.classList.contains('signed'))return; el.classList.add('signed'); el.innerText="å·²ç”Ÿæ•ˆ â¤ï¸"; el.style.background="var(--accent)"; el.style.color="#fff"; el.style.borderStyle="solid"; showToast("åè®®è¾¾æˆï¼"); createParticles(w/2, h/2, ['ğŸŒ¸']); }

    let physCtx, physLoop, balls=[]; const fruits=['ğŸˆ','ğŸŠ','ğŸ’','ğŸ‰','ğŸ¥¥','ğŸ‡','ğŸ¥','ğŸ“','ğŸ¥­'];
    function initGravity() {
        if(physLoop) return; const c=$('gravity-canvas'); physCtx=c.getContext('2d'); const rect=c.getBoundingClientRect(); c.width=rect.width; c.height=rect.height;
        for(let i=0; i<10; i++) balls.push({x:Math.random()*c.width, y:10, vx:0, vy:0, r:22, t:fruits[i%fruits.length]});
        let drag=null; const startD=(x,y)=>balls.forEach(b=>{if(Math.hypot(x-b.x,y-b.y)<30)drag=b;});
        c.addEventListener('mousedown', e=>startD(e.offsetX, e.offsetY)); c.addEventListener('touchstart', e=>{const r=c.getBoundingClientRect(); startD(e.touches[0].clientX-r.left, e.touches[0].clientY-r.top)});
        window.addEventListener('mouseup', ()=>drag=null); window.addEventListener('touchend', ()=>drag=null);
        c.addEventListener('mousemove', e=>{if(drag){drag.x=e.offsetX; drag.y=e.offsetY; drag.vx=0; drag.vy=0;}}); c.addEventListener('touchmove', e=>{if(drag){e.preventDefault(); const r=c.getBoundingClientRect(); drag.x=e.touches[0].clientX-r.left; drag.y=e.touches[0].clientY-r.top; drag.vx=0; drag.vy=0;}});
        window.addEventListener('devicemotion', e=>{if(e.accelerationIncludingGravity){const gx=e.accelerationIncludingGravity.x||0, gy=e.accelerationIncludingGravity.y||0; balls.forEach(b=>{b.vx-=gx*0.5; b.vy+=gy*0.5;});}});
        loopGravity();
    }
    function loopGravity() {
        const c=$('gravity-canvas'); physCtx.clearRect(0,0,c.width,c.height);
        balls.forEach(b=>{
            b.vy+=0.5; b.vx*=0.95; b.vy*=0.95; b.x+=b.vx; b.y+=b.vy;
            if(b.x>c.width-b.r){b.x=c.width-b.r; b.vx*=-0.7;} if(b.x<b.r){b.x=b.r; b.vx*=-0.7;} if(b.y>c.height-b.r){b.y=c.height-b.r; b.vy*=-0.6;} if(b.y<b.r){b.y=b.r; b.vy*=-0.6;}
            physCtx.font="30px Arial"; physCtx.textAlign="center"; physCtx.textBaseline="middle"; physCtx.fillText(b.t, b.x, b.y);
        });
        physLoop=requestAnimationFrame(loopGravity);
    }

    let knotCtx, knotLines=[], knotCleared=false;
    function initKnot() {
        const c=$('knot-canvas'); if(knotLines.length>0)return; c.width=c.offsetWidth; c.height=c.offsetHeight; knotCtx=c.getContext('2d');
        for(let i=0; i<50; i++) knotLines.push({x:c.width/2+(Math.random()-0.5)*100, y:c.height/2+(Math.random()-0.5)*100, cp1x:Math.random()*c.width, cp1y:Math.random()*c.height, cp2x:Math.random()*c.width, cp2y:Math.random()*c.height, color:'#888'});
        drawKnot();
        const untangle=(e)=>{
            e.preventDefault(); if(knotCleared)return; initAudio();
            knotLines.forEach(l=>{ l.color=`hsl(${Math.random()*60+300}, 80%, 70%)`; l.x+=(c.width/2-l.x)*0.05; l.y+=(c.height/2-l.y)*0.05; });
            drawKnot();
            if(Math.abs(knotLines[0].x-c.width/2)<5) { knotCleared=true; showToast("å¿ƒç»“è§£å¼€å•¦ â¤ï¸"); createParticles(c.width/2+c.getBoundingClientRect().left, c.height/2+c.getBoundingClientRect().top, ['â¤ï¸']); }
        };
        c.addEventListener('mousemove', untangle); c.addEventListener('touchmove', untangle);
    }
    function drawKnot() {
        knotCtx.clearRect(0,0,1000,1000); knotCtx.lineWidth=2;
        knotLines.forEach(l=>{ knotCtx.strokeStyle=l.color; knotCtx.beginPath(); knotCtx.moveTo(l.x, l.y); knotCtx.bezierCurveTo(l.cp1x, l.cp1y, l.cp2x, l.cp2y, l.x, l.y); knotCtx.stroke(); });
    }

    let lanternCtx, lanternList=[];
    function initLanterns() { const c=$('lantern-canvas'); c.width=w; c.height=h; lanternCtx=c.getContext('2d'); loopLanterns(); }
    function fireLantern() { const v=$('wish-in').value; if(!v)return; $('wish-in').value=''; lanternList.push({x:Math.random()*w, y:h+50, v:1+Math.random(), text:v, alpha:1}); showToast("æ„¿æœ›å·²å‘é€ âœ¨"); }
    function loopLanterns() { lanternCtx.clearRect(0,0,w,h); for(let i=0; i<lanternList.length; i++) { let l=lanternList[i]; l.y-=l.v; l.alpha-=0.002; lanternCtx.fillStyle=`rgba(255, 165, 0, ${l.alpha})`; lanternCtx.beginPath(); lanternCtx.arc(l.x, l.y, 10, 0, Math.PI*2); lanternCtx.fill(); lanternCtx.fillStyle=`rgba(255, 255, 255, ${l.alpha})`; lanternCtx.font="12px Arial"; lanternCtx.fillText(l.text, l.x+15, l.y); if(l.alpha<=0)lanternList.splice(i,1); } requestAnimationFrame(loopLanterns); }

    function throwBottle() {
        initAudio(); const msg=$('bottle-in').value||"ä¸å¼€å¿ƒ..."; $('bottle-in').value=""; const b=$('bottle-emoji');
        b.style.transition="1s ease-in"; b.style.transform="translate(200px, -50px) rotate(45deg) scale(0.5)"; b.style.opacity="0";
        showToast("å¿ƒäº‹ç“¶å·²é£˜èµ°~"); playTone(400,'sine',0.2);
        setTimeout(()=>{
            const replies=["æˆ‘åœ¨å¬","æŠ±æŠ±ä½ ","åˆ«éš¾è¿‡å•¦","ä¸€ç›´åœ¨","å‘¼å™œå‘¼å™œæ¯›","ä»Šæ™šæœˆè‰²çœŸç¾","æ”¶åˆ°å•¦"]; const reply=replies[Math.floor(Math.random()*replies.length)];
            b.style.transition="none"; b.style.transform="translate(-200px, 0px) rotate(-45deg) scale(0.5)";
            setTimeout(()=>{
                b.style.transition="1s ease-out"; b.style.transform="translate(0, 0) rotate(0) scale(1)"; b.style.opacity="1";
                setTimeout(()=>{ const txt=$('bottle-msg'); txt.innerText="ğŸ’Œ "+reply; txt.style.opacity=1; showToast("æ”¶åˆ°ä¸€ä¸ªå›ä¿¡ï¼"); speak(reply); setTimeout(()=>{txt.style.opacity=0;},3000); },1000);
            },100);
        },2000);
    }

    function fAct(t, el) { initAudio(); const i=el.querySelector('.f-icon'); if(t==='durian'){i.innerText='ğŸ§'; showToast("æ€åº¦è¯šæ³ï¼"); setTimeout(()=>i.innerText='ğŸˆ',1500);} else if(t==='grape'){el.style.transform='scale(0.8)'; setTimeout(()=>el.style.transform='scale(1)',150); playTone(600,'triangle',0.1);} else if(t==='cherry'){i.style.transform='rotate(360deg)'; setTimeout(()=>i.style.transform='',500);} else {showToast('çˆ±ä½ å“Ÿ'); createParticles(w/2, h/2, ['â¤ï¸']);} }
    function playVm() { initAudio(); const items=['ğŸ’','ğŸ’„','ğŸ§','ğŸ§¸','ğŸ’Œ','ğŸŒŸ','ğŸ¬']; const r=items[Math.floor(Math.random()*items.length)]; $('vm-res').innerText=r; $('vm-res').style.transform="translateY(10px)"; playTone(800,'square',0.1); setTimeout(()=>{ $('vm-res').style.transform="translateY(0)"; showToast("è·å¾—: "+r); createParticles(w/2, h/2, [r]); },200); }
    let hCtx, hList=[];
    function initBlackHole() { const c=$('hole-canvas'); hCtx=c.getContext('2d'); c.width=c.offsetWidth; c.height=c.offsetHeight; loopHole(); }
    function fireBlackHole() { const v=$('worry-in').value; if(!v)return; $('worry-in').value=''; speak("ç²‰ç¢çƒ¦æ¼"); for(let i=0;i<v.length;i++) hList.push({x:Math.random()*200, y:200, vx:(Math.random()-.5)*2, vy:-5, c:v[i]}); }
    function loopHole() { hCtx.fillStyle='rgba(0,0,0,0.2)'; hCtx.fillRect(0,0,1000,1000); const cx=$('hole-canvas').width/2, cy=$('hole-canvas').height/2; hCtx.beginPath(); hCtx.arc(cx,cy,15,0,Math.PI*2); hCtx.fillStyle='#f00'; hCtx.fill(); for(let i=0;i<hList.length;i++){ let p=hList[i], dx=cx-p.x, dy=cy-p.y, a=Math.atan2(dy,dx); p.vx+=Math.cos(a)*0.5; p.vy+=Math.sin(a)*0.5; p.x+=p.vx; p.y+=p.vy; hCtx.fillStyle='#fff'; hCtx.fillText(p.c, p.x, p.y); if(Math.hypot(dx,dy)<10) hList.splice(i,1); } requestAnimationFrame(loopHole); }
    function note(f, el) { initAudio(); el.classList.add('active'); setTimeout(()=>el.classList.remove('active'),150); playTone(f,'sine',0.5); createParticles(el.getBoundingClientRect().left+15, el.getBoundingClientRect().top, ['ğŸµ']); }

    let sCtx, stars=[], lines=[];
    function initStar() { const c=$('star-canvas'); sCtx=c.getContext('2d'); const r=c.getBoundingClientRect(); c.width=r.width; c.height=r.height; stars=[]; for(let i=0;i<Math.PI*2;i+=0.6) stars.push({x:c.width/2+16*Math.pow(Math.sin(i),3)*5, y:c.height/2-(13*Math.cos(i)-5*Math.cos(2*i)-2*Math.cos(3*i)-Math.cos(4*i))*5, ok:false}); drawStar(); c.addEventListener('touchmove', e=>{e.preventDefault(); const t=e.touches[0]; const b=c.getBoundingClientRect(); const x=t.clientX-b.left, y=t.clientY-b.top; stars.forEach(s=>{if(Math.hypot(x-s.x,y-s.y)<20)s.ok=true;}); lines.push({x,y}); drawStar(); if(stars.every(s=>s.ok)) { $('star-msg').innerText=config.msg; $('star-msg').style.opacity=1; }}); }
    function drawStar() { sCtx.clearRect(0,0,1000,1000); stars.forEach(s=>{ sCtx.beginPath(); sCtx.arc(s.x,s.y,4,0,Math.PI*2); sCtx.fillStyle=s.ok?'red':'#fff'; sCtx.fill(); }); sCtx.beginPath(); sCtx.strokeStyle='rgba(255,255,255,0.5)'; if(lines.length){sCtx.moveTo(lines[0].x, lines[0].y); lines.forEach(l=>sCtx.lineTo(l.x,l.y)); sCtx.stroke();} }

    const sc=$('scratch-canvas'), sct=sc.getContext('2d');
    function initScratch() { const p=sc.parentElement; sc.width=p.offsetWidth; sc.height=p.offsetHeight; sct.fillStyle='#ddd'; sct.fillRect(0,0,sc.width, sc.height); sct.fillStyle='#888'; sct.font="20px Arial"; sct.fillText("è¿™é‡Œæœ‰ç°å°˜ (æ“¦æ‰)", 50, 90); sct.globalCompositeOperation='destination-out'; const m=(e)=>{e.preventDefault(); const t=e.touches?e.touches[0]:e; const r=sc.getBoundingClientRect(); sct.beginPath(); sct.arc(t.clientX-r.left, t.clientY-r.top, 25, 0, Math.PI*2); sct.fill();}; sc.addEventListener('mousemove', m); sc.addEventListener('touchmove', m); }
    function resetScratch() { sct.globalCompositeOperation='source-over'; initScratch(); }

    let parts=[]; function createParticles(x,y,c){for(let i=0;i<10;i++)parts.push({x,y,vx:(Math.random()-.5)*10,vy:(Math.random()-.5)*10,c:c[0],l:1}); loopFx();}
    function loopFx(){ fxCtx.clearRect(0,0,w,h); let a=false; parts.forEach(p=>{if(p.l<=0)return; a=true; p.x+=p.vx; p.y+=p.vy; p.vy+=0.5; p.l-=0.02; fxCtx.font="24px Arial"; fxCtx.globalAlpha=p.l; fxCtx.fillText(p.c,p.x,p.y);}); if(a)requestAnimationFrame(loopFx); }
    function openSettings(){$('settings-modal').style.display='flex'; $('set-name').value=config.name; $('set-msg').value=config.msg;}
    function saveSettings(){ config.name=$('set-name').value||config.name; config.msg=$('set-msg').value||config.msg; localStorage.setItem('u_name',config.name); localStorage.setItem('u_msg',config.msg); $('user-name').innerText=config.name; $('love-msg').innerText=config.msg; $('settings-modal').style.display='none'; showToast("å·²ä¿å­˜"); }
    window.onload = () => { setWeather('sunny', document.querySelector('.w-btn')); }
</script>
</body>
</html>